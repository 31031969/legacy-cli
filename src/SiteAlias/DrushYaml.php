<?php

namespace Platformsh\Cli\SiteAlias;

use Platformsh\Client\Model\Project;
use Symfony\Component\Yaml\Yaml;

class DrushYaml extends DrushAlias
{
    /**
     * {@inheritdoc}
     */
    protected function getFilename($groupName, $drushDir)
    {
        return $drushDir . '/' . $groupName . '.aliases.yml';
    }

    /**
     * {@inheritdoc}
     */
    protected function formatComment($comment)
    {
        return preg_replace('/^/m', '# ', trim($comment));
    }

    /**
     * {@inheritdoc}
     */
    protected function formatAliases(array $aliases)
    {
        $formatted = [];
        foreach ($aliases as $aliasName => $newAlias) {
            $formatted[] = $this->formatAlias($newAlias['alias'], $aliasName, isset($newAlias['comment']) ? $newAlias['comment'] : '');
        }

        return implode("\n", preg_replace('/^/m', '    ', $formatted));
    }

    /**
     * {@inheritdoc}
     */
    protected function formatAlias(array $alias, $name, $comment = '')
    {
        $formatted = Yaml::dump([$name => $alias]);
        if (!empty($comment)) {
            $formatted = $this->formatComment($comment) .  "\n" . $formatted;
        }

        return $formatted;
    }

    /**
     * {@inheritdoc}
     */
    protected function getExistingAliases(array $filenames)
    {
        $aliases = [];
        foreach ($filenames as $filename) {
            if (file_exists($filename) && ($content = file_get_contents($filename))) {
                $parsed = (array) Yaml::parse($content);
                if (!empty($parsed['sites'])) {
                    $aliases = array_merge($aliases, (array) $parsed['sites']);
                }
            }
        }

        return $aliases;
    }

    /**
     * {@inheritdoc}
     */
    protected function getHeader(Project $project)
    {
        return "# Drush aliases for the " . $this->config->get('service.name') . " project \"{$project->title}\"."
            . "\n#"
            . "\n# This file is auto-generated by the " . $this->config->get('application.name') . "."
            . "\n#"
            . "\n# WARNING"
            . "\n# This file may be regenerated at any time."
            . "\n# - User-defined aliases will be preserved."
            . "\n# - Aliases for active environments (including any custom additions) will be preserved."
            . "\n# - Aliases for deleted or inactive environments will be deleted."
            . "\n# - All other information will be deleted."
            . "\n#\n\n"
            . "sites:\n";
    }
}
