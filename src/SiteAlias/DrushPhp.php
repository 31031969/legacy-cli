<?php

namespace Platformsh\Cli\SiteAlias;

use Platformsh\Client\Model\Project;

class DrushPhp extends DrushAlias
{
    /**
     * {@inheritdoc}
     */
    protected function getFilename($groupName, $drushDir)
    {
        return $drushDir . '/' . $groupName . '.aliases.drushrc.php';
    }

    /**
     * {@inheritdoc}
     */
    protected function formatComment($comment)
    {
        return preg_replace('/^/m', '// $1', trim($comment));
    }

    /**
     * {@inheritdoc}
     */
    protected function formatAlias(array $alias, $name, $comment = '')
    {
        $formatted = sprintf(
            "\$aliases['%s'] = %s;\n",
            str_replace("'", "\\'", $name),
            var_export($alias, true)
        );
        if (!empty($comment)) {
            $formatted = $this->formatComment($comment) .  "\n" . $formatted;
        }

        return $formatted;
    }

    /**
     * {@inheritdoc}
     */
    protected function getExistingAliases(array $filenames)
    {
        // This may create a PHP parse error for invalid syntax in the alias
        // file, but in that case the user could not run Drush anyway.
        $aliases = [];
        foreach ($filenames as $filename) {
            if (file_exists($filename)) {
                include $filename;
            }
        }

        return $aliases;
    }

    /**
     * {@inheritdoc}
     */
    protected function getHeader(Project $project)
    {
        return "<?php\n"
            . "/**\n * @file"
            . "\n * Drush aliases for the " . $this->config->get('service.name') . " project \"{$project->title}\"."
            . "\n *"
            . "\n * This file is auto-generated by the " . $this->config->get('application.name') . "."
            . "\n *"
            . "\n * WARNING"
            . "\n * This file may be regenerated at any time."
            . "\n * - User-defined aliases will be preserved."
            . "\n * - Aliases for active environments (including any custom additions) will be preserved."
            . "\n * - Aliases for deleted or inactive environments will be deleted."
            . "\n * - All other information will be deleted."
            . "\n */\n\n";
    }
}
